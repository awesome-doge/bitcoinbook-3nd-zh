name: Build Release (HTML + PDF + EPUB)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v3.0.0-zh-tw)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install AsciiDoctor toolchain
        run: |
          gem install asciidoctor
          gem install asciidoctor-pdf
          gem install asciidoctor-epub3
          gem install rouge
          gem install coderay

      - name: Install CJK fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-noto-cjk \
            fonts-noto-cjk-extra \
            fonts-wqy-microhei \
            fonts-wqy-zenhei

      - name: Create release directory
        run: mkdir -p release

      - name: Build HTML (standalone)
        run: |
          cd zh-tw
          asciidoctor \
            --backend=html5 \
            --out-file=../release/mastering-bitcoin-3rd-zh-tw.html \
            --attribute=source-highlighter=rouge \
            --attribute=toc=left \
            --attribute=toclevels=3 \
            --attribute=icons=font \
            --attribute=sectanchors \
            --attribute=idprefix= \
            --attribute=idseparator=- \
            book.adoc

      - name: Build PDF
        run: |
          cd zh-tw
          asciidoctor-pdf \
            --out-file=../release/mastering-bitcoin-3rd-zh-tw.pdf \
            --attribute=source-highlighter=rouge \
            --attribute=pdf-theme=default-with-fallback-font \
            --attribute=scripts=cjk \
            --attribute=allow-uri-read \
            book.adoc

      - name: Build EPUB
        run: |
          cd zh-tw
          asciidoctor-epub3 \
            --out-file=../release/mastering-bitcoin-3rd-zh-tw.epub \
            --attribute=source-highlighter=rouge \
            --attribute=ebook-format=kf8 \
            book.adoc

      - name: Package HTML with images
        run: |
          mkdir -p release/html-package
          cp release/mastering-bitcoin-3rd-zh-tw.html release/html-package/
          cp -r images release/html-package/
          cd release
          zip -r mastering-bitcoin-3rd-zh-tw-html.zip html-package/

      - name: Generate checksums
        run: |
          cd release
          sha256sum mastering-bitcoin-3rd-zh-tw.html > checksums.txt
          sha256sum mastering-bitcoin-3rd-zh-tw.pdf >> checksums.txt
          sha256sum mastering-bitcoin-3rd-zh-tw.epub >> checksums.txt
          sha256sum mastering-bitcoin-3rd-zh-tw-html.zip >> checksums.txt

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ç²¾é€šæ¯”ç‰¹å¹£ç¬¬ä¸‰ç‰ˆç¹é«”ä¸­æ–‡ ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            # ç²¾é€šæ¯”ç‰¹å¹£ç¬¬ä¸‰ç‰ˆ - ç¹é«”ä¸­æ–‡ç‰ˆ ${{ steps.get_version.outputs.version }}

            æœ¬æ¬¡ç™¼ä½ˆåŒ…å«ä»¥ä¸‹æ ¼å¼ï¼š

            ## ğŸ“š ä¸‹è¼‰æª”æ¡ˆ

            - **HTML å–®é ç‰ˆ**: `mastering-bitcoin-3rd-zh-tw.html` - å¯åœ¨ç€è¦½å™¨ç›´æ¥é–‹å•Ÿ
            - **HTML å®Œæ•´åŒ…**: `mastering-bitcoin-3rd-zh-tw-html.zip` - åŒ…å«æ‰€æœ‰åœ–ç‰‡çš„å®Œæ•´ç‰ˆæœ¬
            - **PDF ç‰ˆ**: `mastering-bitcoin-3rd-zh-tw.pdf` - é©åˆåˆ—å°å’Œé›¢ç·šé–±è®€
            - **EPUB ç‰ˆ**: `mastering-bitcoin-3rd-zh-tw.epub` - é©åˆé›»å­æ›¸é–±è®€å™¨

            ## ğŸŒ ç·šä¸Šé–±è®€

            è¨ªå• [https://bitcoinbook-3nd-zh.doge.tg](https://bitcoinbook-3nd-zh.doge.tg) ç·šä¸Šé–±è®€æœ€æ–°ç‰ˆæœ¬ã€‚

            ## âœ… æª”æ¡ˆé©—è­‰

            è«‹ä½¿ç”¨ `checksums.txt` æª”æ¡ˆé©—è­‰ä¸‹è¼‰æª”æ¡ˆçš„å®Œæ•´æ€§ï¼š

            ```bash
            sha256sum -c checksums.txt
            ```

            ## ğŸ“– é—œæ–¼æœ¬æ›¸

            ã€Šç²¾é€šæ¯”ç‰¹å¹£ï¼šç¨‹å¼è¨­è¨ˆé–‹æ”¾å€å¡Šéˆï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ã€‹ç”± Andreas M. Antonopoulos å’Œ David A. Harding è‘—ä½œï¼Œæœ¬ç‰ˆæœ¬ç‚ºç¹é«”ä¸­æ–‡ç¿»è­¯ã€‚

            - **åŸä½œè€…**: Andreas M. Antonopoulos, David A. Harding
            - **è­¯è€…**: Dr. Awesome Doge
            - **æˆæ¬Š**: CC-BY-SA 4.0 International

            ---

            ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªå‹•å»ºç½®
          files: |
            release/mastering-bitcoin-3rd-zh-tw.html
            release/mastering-bitcoin-3rd-zh-tw.pdf
            release/mastering-bitcoin-3rd-zh-tw.epub
            release/mastering-bitcoin-3rd-zh-tw-html.zip
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-files
          path: release/
          retention-days: 30
