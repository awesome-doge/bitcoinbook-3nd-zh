name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è¨±ä¸€å€‹éƒ¨ç½²åŒæ™‚é€²è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install AsciiDoctor
        run: |
          gem install asciidoctor
          gem install asciidoctor-pdf
          gem install rouge
          asciidoctor --version

      - name: Create output directory
        run: |
          mkdir -p docs
          mkdir -p docs/images
          mkdir -p docs/code

      - name: Build Chinese version HTML
        run: |
          if [ -f "zh-tw/book.adoc" ]; then
            echo "Building Chinese version from zh-tw/book.adoc"
            cd zh-tw
            asciidoctor \
              --failure-level=WARN \
              --backend=html5 \
              --out-file=../docs/index.html \
              --attribute=source-highlighter=rouge \
              --attribute=toc=left \
              --attribute=toclevels=2 \
              --attribute=sectnums \
              --attribute=sectnumlevels=2 \
              --attribute=icons=font \
              --attribute=lang=zh-TW \
              --attribute=imagesdir=.. \
              book.adoc
            cd ..
          else
            echo "Chinese translation not yet available. Creating placeholder."
            cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ç²¾é€šæ¯”ç‰¹å¹£ï¼ˆç¬¬ä¸‰ç‰ˆï¼‰- ç¹é«”ä¸­æ–‡ç¿»è­¯</title>
              <style>
                  body {
                      font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.8;
                  }
                  h1 { color: #f7931a; }
                  .status {
                      background: #f0f0f0;
                      padding: 20px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  a { color: #f7931a; }
              </style>
          </head>
          <body>
              <h1>ç²¾é€šæ¯”ç‰¹å¹£ï¼ˆç¬¬ä¸‰ç‰ˆï¼‰</h1>
              <h2>ç¹é«”ä¸­æ–‡ç¿»è­¯å°ˆæ¡ˆ</h2>

              <div class="status">
                  <h3>ğŸš§ å°ˆæ¡ˆé€²è¡Œä¸­</h3>
                  <p>æœ¬å°ˆæ¡ˆæ­£åœ¨ç©æ¥µç¿»è­¯ã€ŠMastering Bitcoinã€‹ç¬¬ä¸‰ç‰ˆæˆç¹é«”ä¸­æ–‡ã€‚</p>
                  <p><strong>åŸæ›¸ä½œè€…</strong>ï¼šAndreas M. Antonopoulos, David A. Harding</p>
                  <p><strong>æˆæ¬Š</strong>ï¼šCC-BY-SA 4.0 International</p>
              </div>

              <h3>å°ˆæ¡ˆè³‡è¨Š</h3>
              <ul>
                  <li><a href="https://github.com/awesome-doge/bitcoinbook-3nd-zh">GitHub å€‰åº«</a></li>
                  <li><a href="https://github.com/awesome-doge/bitcoinbook-3nd-zh/blob/develop/TRANSLATION_PLAN.md">ç¿»è­¯è¦åŠƒ</a></li>
                  <li><a href="https://github.com/bitcoinbook/bitcoinbook">åŸæ›¸å€‰åº«</a></li>
              </ul>

              <h3>å¦‚ä½•è²¢ç»</h3>
              <p>æˆ‘å€‘æ­¡è¿å„ç¨®å½¢å¼çš„è²¢ç»ï¼è«‹æŸ¥çœ‹ <a href="https://github.com/awesome-doge/bitcoinbook-3nd-zh/blob/develop/TRANSLATION_PLAN.md">ç¿»è­¯è¦åŠƒ</a> äº†è§£å¦‚ä½•åƒèˆ‡ã€‚</p>
          </body>
          </html>
          EOF
          fi

      - name: Copy images
        run: |
          if [ -d "images" ]; then
            cp -r images/* docs/images/ || true
          fi

      - name: Copy code examples
        run: |
          if [ -d "code" ]; then
            cp -r code/* docs/code/ || true
          fi

      - name: Copy theme files
        run: |
          if [ -d "theme" ]; then
            mkdir -p docs/theme
            cp -r theme/* docs/theme/ || true
          fi

      - name: Create CNAME file
        run: |
          echo "bitcoinbook-3nd-zh.doge.tg" > docs/CNAME

      - name: Create .nojekyll
        run: |
          touch docs/.nojekyll

      - name: Build Chinese version PDF
        run: |
          if [ -f "zh-tw/book.adoc" ]; then
            echo "Building Chinese version PDF from zh-tw/book.adoc"
            cd zh-tw
            asciidoctor-pdf \
              --failure-level=WARN \
              --out-file=../docs/mastering-bitcoin-3rd-zh-tw.pdf \
              --attribute=source-highlighter=rouge \
              --attribute=imagesdir=.. \
              book.adoc || echo "PDF generation failed, continuing..."
            cd ..
          fi

      - name: Build Chinese version EPUB
        run: |
          if command -v asciidoctor-epub3 &> /dev/null; then
            if [ -f "zh-tw/book.adoc" ]; then
              echo "Building Chinese version EPUB from zh-tw/book.adoc"
              cd zh-tw
              asciidoctor-epub3 \
                --failure-level=WARN \
                --out-file=../docs/mastering-bitcoin-3rd-zh-tw.epub \
                --attribute=imagesdir=.. \
                book.adoc || echo "EPUB generation failed, continuing..."
              cd ..
            fi
          else
            echo "asciidoctor-epub3 not available, skipping EPUB generation"
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    needs: build
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop' && startsWith(github.event.head_commit.message, 'Release')
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install AsciiDoctor tools
        run: |
          gem install asciidoctor
          gem install asciidoctor-pdf
          gem install asciidoctor-epub3
          gem install rouge

      - name: Build PDF
        run: |
          cd zh-tw
          asciidoctor-pdf \
            --failure-level=WARN \
            --out-file=../mastering-bitcoin-3rd-zh-tw.pdf \
            --attribute=source-highlighter=rouge \
            --attribute=imagesdir=.. \
            book.adoc

      - name: Build EPUB
        run: |
          cd zh-tw
          asciidoctor-epub3 \
            --failure-level=WARN \
            --out-file=../mastering-bitcoin-3rd-zh-tw.epub \
            --attribute=imagesdir=.. \
            book.adoc

      - name: Build HTML (single file)
        run: |
          cd zh-tw
          asciidoctor \
            --backend=html5 \
            --out-file=../mastering-bitcoin-3rd-zh-tw.html \
            --attribute=source-highlighter=rouge \
            --attribute=toc=left \
            --attribute=toclevels=2 \
            --attribute=lang=zh-TW \
            --attribute=imagesdir=.. \
            book.adoc

      - name: Get version from commit
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ç²¾é€šæ¯”ç‰¹å¹£ç¬¬ä¸‰ç‰ˆç¹é«”ä¸­æ–‡ ${{ steps.version.outputs.version }}
          body: |
            # ç²¾é€šæ¯”ç‰¹å¹£ï¼šç¨‹å¼è¨­è¨ˆé–‹æ”¾å€å¡Šéˆï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ç¹é«”ä¸­æ–‡ç¿»è­¯

            **ç™¼å¸ƒæ—¥æœŸ**ï¼š${{ steps.version.outputs.date }}
            **è­¯è€…**ï¼šDr. Awesome Doge
            **åŸä½œè€…**ï¼šAndreas M. Antonopoulos, David A. Harding
            **æˆæ¬Š**ï¼šCC-BY-SA 4.0 International

            ## ğŸ“¥ ä¸‹è¼‰æ ¼å¼

            - **PDF**ï¼šé©åˆåˆ—å°å’Œé›¢ç·šé–±è®€
            - **EPUB**ï¼šé©åˆé›»å­æ›¸é–±è®€å™¨
            - **HTML**ï¼šå–®ä¸€ HTML æª”æ¡ˆï¼Œå¯åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ

            ## ğŸŒ ç·šä¸Šé–±è®€

            è¨ªå• [https://bitcoinbook-3nd-zh.doge.tg](https://bitcoinbook-3nd-zh.doge.tg) ç·šä¸Šé–±è®€

            ## ğŸ“ ç¿»è­¯é€²åº¦

            - âœ… å‰è¨€ï¼ˆ100%ï¼‰
            - âœ… ç¬¬ 1-14 ç« ï¼ˆ100%ï¼‰
            - âœ… é™„éŒ„ A-Cï¼ˆ100%ï¼‰
            - âœ… è©å½™è¡¨ï¼ˆ100%ï¼‰

            **ç¸½é€²åº¦**ï¼š19/19 æª”æ¡ˆï¼ˆ100%ï¼‰

            ## ğŸ™ è‡´è¬

            æ„Ÿè¬æ‰€æœ‰ç‚ºæœ¬ç¿»è­¯å°ˆæ¡ˆåšå‡ºè²¢ç»çš„è­¯è€…ã€å¯©æ ¡è€…å’Œæ”¯æŒè€…ï¼
          draft: false
          prerelease: false
          files: |
            mastering-bitcoin-3rd-zh-tw.pdf
            mastering-bitcoin-3rd-zh-tw.epub
            mastering-bitcoin-3rd-zh-tw.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
